{% extends "base.html" %}

{% block title %}Register Hospital - Hospital Booking System{% endblock %}

{% block content %}
<div class="container" style="max-width: 700px; margin-top: 4rem;">
    <div class="card">
        <div class="card-header">
            <h2 class="card-title text-center">Hospital Registration</h2>
            <p style="text-align: center; color: var(--text-light); margin-top: 0.5rem;">
                Register your hospital to use our booking system. Approval required.
            </p>
        </div>
        
        <div id="alert-container"></div>
        
        <form id="hospitalForm">
            <div class="form-group">
                <label class="form-label" for="name">Hospital Name <span style="color: var(--danger-color);">*</span></label>
                <input type="text" class="form-control" id="name" name="name" required 
                       placeholder="Enter hospital name">
            </div>
            
            <div class="form-group">
                <label class="form-label" for="email">Email Address <span style="color: var(--danger-color);">*</span></label>
                <input type="email" class="form-control" id="email" name="email" required 
                       placeholder="Enter hospital email">
            </div>
            
            <div class="form-group">
                <label class="form-label" for="mobile">Mobile Number <span style="color: var(--danger-color);">*</span></label>
                <input type="text" class="form-control" id="mobile" name="mobile" required 
                       placeholder="Enter hospital contact number">
            </div>
            
            <div class="form-group">
                <label class="form-label" for="address_line1">Address Line 1</label>
                <input type="text" class="form-control" id="address_line1" name="address_line1" 
                       placeholder="Street address">
            </div>
            
            <div class="form-group">
                <label class="form-label" for="address_line2">Address Line 2</label>
                <input type="text" class="form-control" id="address_line2" name="address_line2" 
                       placeholder="Area/Locality">
            </div>
            
            <div class="form-group">
                <label class="form-label" for="address_line3">Address Line 3</label>
                <input type="text" class="form-control" id="address_line3" name="address_line3" 
                       placeholder="City, State, PIN">
            </div>
            
            <div class="form-group">
                <label class="form-label" for="city">City</label>
                <input type="text" class="form-control" id="city" name="city" 
                       placeholder="Enter city">
            </div>
            
            <div class="form-group">
                <label class="form-label" for="state">State</label>
                <input type="text" class="form-control" id="state" name="state" 
                       placeholder="Enter state">
            </div>
            
            <div class="form-group">
                <label class="form-label" for="pincode">Pincode</label>
                <input type="text" class="form-control" id="pincode" name="pincode" 
                       placeholder="Enter pincode">
            </div>
            
            <!-- WhatsApp Integration Section -->
            <div style="margin-top: 2rem; padding-top: 2rem; border-top: 2px solid var(--border-color);">
                <h3 style="font-size: 1.25rem; color: var(--text-dark); margin-bottom: 1rem; font-weight: 600;">
                    üì± WhatsApp Integration (Optional)
                </h3>
                <p style="color: var(--text-light); font-size: 0.875rem; margin-bottom: 1.5rem;">
                    Connect your WhatsApp to send automatic appointment confirmations and reminders to patients.
                </p>
                
                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" id="enable_whatsapp" name="enable_whatsapp" style="margin-right: 0.5rem;">
                        Enable WhatsApp notifications
                    </label>
                    <small style="color: var(--text-light); font-size: 0.875rem; display: block; margin-top: 0.5rem;">
                        You can initialize WhatsApp after registration by clicking the "Initialize WhatsApp" button.
                    </small>
                </div>
                
                <div id="whatsapp-status" style="display: none; margin-top: 1rem; padding: 1rem; background: var(--bg-light); border-radius: 0.5rem;">
                    <p style="color: var(--text-dark); font-weight: 600; margin-bottom: 0.5rem;">WhatsApp Status:</p>
                    <p id="whatsapp-status-text" style="color: var(--text-light); font-size: 0.875rem;">Not initialized</p>
                </div>
            </div>
            
            <!-- Payment UPI IDs Section -->
            <div style="margin-top: 2rem; padding-top: 2rem; border-top: 2px solid var(--border-color);">
                <h3 style="font-size: 1.25rem; color: var(--text-dark); margin-bottom: 1rem; font-weight: 600;">
                    Payment UPI IDs (Optional)
                </h3>
                <p style="color: var(--text-light); font-size: 0.875rem; margin-bottom: 1.5rem;">
                    Add your UPI IDs for different payment apps. These will be used for receiving payments from patients.
                </p>
                
                <div class="form-group">
                    <label class="form-label" for="upi_id">Default UPI ID</label>
                    <input type="text" class="form-control" id="upi_id" name="upi_id" 
                           placeholder="e.g., hospital@paytm">
                    <small style="color: var(--text-light); font-size: 0.875rem;">Universal UPI ID (used if app-specific IDs not provided)</small>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="gpay_upi_id">üì± Google Pay UPI ID</label>
                    <input type="text" class="form-control" id="gpay_upi_id" name="gpay_upi_id" 
                           placeholder="e.g., hospital@okaxis">
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="phonepay_upi_id">üí≥ PhonePe UPI ID</label>
                    <input type="text" class="form-control" id="phonepay_upi_id" name="phonepay_upi_id" 
                           placeholder="e.g., hospital@ybl">
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="paytm_upi_id">üíµ Paytm UPI ID</label>
                    <input type="text" class="form-control" id="paytm_upi_id" name="paytm_upi_id" 
                           placeholder="e.g., hospital@paytm">
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="bhim_upi_id">üè¶ BHIM UPI ID</label>
                    <input type="text" class="form-control" id="bhim_upi_id" name="bhim_upi_id" 
                           placeholder="e.g., hospital@upi">
                </div>
            </div>
            
            <div class="alert alert-info">
                <strong>Note:</strong> After registration, an approval request will be sent to the administrator. 
                You will be notified once your hospital is approved. Only approved hospitals can be selected during user registration.
            </div>
            
            <button type="submit" class="btn btn-primary" style="width: 100%;">Submit Registration Request</button>
        </form>
        
        <div style="text-align: center; margin-top: 1.5rem;">
            <p style="color: var(--text-light);">
                <a href="/" style="color: var(--primary-color);">Back to Home</a> | 
                <a href="/register" style="color: var(--primary-color);">User Registration</a>
            </p>
        </div>
    </div>
</div>

<script>
document.getElementById('hospitalForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const alertContainer = document.getElementById('alert-container');
    
    const formData = {
        name: document.getElementById('name').value,
        email: document.getElementById('email').value,
        mobile: document.getElementById('mobile').value,
        address_line1: document.getElementById('address_line1').value,
        address_line2: document.getElementById('address_line2').value,
        address_line3: document.getElementById('address_line3').value,
        city: document.getElementById('city').value,
        state: document.getElementById('state').value,
        pincode: document.getElementById('pincode').value,
        upi_id: document.getElementById('upi_id').value || null,
        gpay_upi_id: document.getElementById('gpay_upi_id').value || null,
        phonepay_upi_id: document.getElementById('phonepay_upi_id').value || null,
        paytm_upi_id: document.getElementById('paytm_upi_id').value || null,
        bhim_upi_id: document.getElementById('bhim_upi_id').value || null
    };
    
    try {
        const response = await fetch('/api/hospitals/register', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
        });
        
        const data = await response.json();
        
        if (response.ok) {
            const hospitalId = data.id;
            const enableWhatsApp = document.getElementById('enable_whatsapp').checked;
            
            alertContainer.innerHTML = `
                <div class="alert alert-success">
                    <strong>Registration Submitted Successfully!</strong><br>
                    Your hospital registration request has been sent for approval. 
                    An email notification has been sent to the administrator.<br>
                    Hospital ID: ${hospitalId}<br>
                    Status: ${data.status}
                </div>
            `;
            
            // If WhatsApp is enabled, initialize it
            if (enableWhatsApp) {
                await initializeWhatsApp(hospitalId);
            }
            
            document.getElementById('hospitalForm').reset();
            
            // Redirect to payment setup page with hospital ID
            setTimeout(() => {
                window.location.href = `/hospital-payment-setup?hospital_id=${hospitalId}`;
            }, enableWhatsApp ? 5000 : 2000);
        } else {
            alertContainer.innerHTML = `<div class="alert alert-error">${data.detail || 'Registration failed'}</div>`;
        }
        } catch (error) {
        alertContainer.innerHTML = `<div class="alert alert-error">${error.message}</div>`;
    }
});

// Initialize WhatsApp for hospital
async function initializeWhatsApp(hospitalId) {
    const alertContainer = document.getElementById('alert-container');
    const statusDiv = document.getElementById('whatsapp-status');
    const statusText = document.getElementById('whatsapp-status-text');
    
    try {
        // Show status
        statusDiv.style.display = 'block';
        statusText.textContent = 'Initializing WhatsApp...';
        statusText.style.color = 'var(--primary-color)';
        
        // Enable WhatsApp first
        const enableResponse = await fetch(`/api/hospitals/${hospitalId}/whatsapp-settings`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                whatsapp_enabled: 'true'
            })
        });
        
        if (!enableResponse.ok) {
            throw new Error('Failed to enable WhatsApp');
        }
        
        // Initialize WhatsApp session
        const initResponse = await fetch(`/api/hospitals/${hospitalId}/whatsapp-init`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const initData = await initResponse.json();
        
        if (initResponse.ok) {
            statusText.textContent = 'WhatsApp initialization started! A browser window will open. Please scan the QR code with your WhatsApp mobile app.';
            statusText.style.color = 'var(--success-color)';
            
            // Add success message to alert container
            const successMsg = document.createElement('div');
            successMsg.className = 'alert alert-success';
            successMsg.style.marginTop = '1rem';
            successMsg.innerHTML = `
                <strong>üì± WhatsApp Initialization Started!</strong><br>
                A browser window should open automatically. If not, please check your browser settings.<br>
                <strong>Steps:</strong><br>
                1. Scan the QR code shown in the browser window<br>
                2. Use your hospital's WhatsApp mobile app to scan<br>
                3. Once scanned, WhatsApp will be connected automatically<br>
                <small style="color: var(--text-light);">You can close the browser window after scanning.</small>
            `;
            alertContainer.appendChild(successMsg);
            
            // Check status after a delay
            setTimeout(async () => {
                await checkWhatsAppStatus(hospitalId);
            }, 3000);
        } else {
            throw new Error(initData.detail || 'Failed to initialize WhatsApp');
        }
    } catch (error) {
        statusText.textContent = `Error: ${error.message}`;
        statusText.style.color = 'var(--danger-color)';
        
        const errorMsg = document.createElement('div');
        errorMsg.className = 'alert alert-error';
        errorMsg.style.marginTop = '1rem';
        errorMsg.innerHTML = `<strong>WhatsApp Initialization Failed:</strong> ${error.message}`;
        alertContainer.appendChild(errorMsg);
    }
}

// Check WhatsApp status
async function checkWhatsAppStatus(hospitalId) {
    try {
        const response = await fetch(`/api/hospitals/${hospitalId}/whatsapp-status`);
        const data = await response.json();
        
        const statusText = document.getElementById('whatsapp-status-text');
        if (data.session_active) {
            statusText.textContent = '‚úÖ WhatsApp connected successfully!';
            statusText.style.color = 'var(--success-color)';
        } else {
            statusText.textContent = '‚è≥ Waiting for QR code scan...';
            statusText.style.color = 'var(--warning-color)';
        }
    } catch (error) {
        console.error('Error checking WhatsApp status:', error);
    }
}

// Check if we're on a page with hospital_id in URL (for post-registration)
const urlParams = new URLSearchParams(window.location.search);
const existingHospitalId = urlParams.get('hospital_id');
if (existingHospitalId) {
    // Show WhatsApp initialization option for existing hospitals
    document.getElementById('whatsapp-status').style.display = 'block';
    checkWhatsAppStatus(existingHospitalId);
    
    // Add initialize button
    const whatsappSection = document.querySelector('h3:contains("WhatsApp Integration")')?.parentElement;
    if (whatsappSection) {
        const initButton = document.createElement('button');
        initButton.type = 'button';
        initButton.className = 'btn btn-primary';
        initButton.textContent = 'Initialize WhatsApp';
        initButton.style.marginTop = '1rem';
        initButton.onclick = () => initializeWhatsApp(existingHospitalId);
        whatsappSection.appendChild(initButton);
    }
}
</script>
{% endblock %}

