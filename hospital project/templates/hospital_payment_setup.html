{% extends "base.html" %}

{% block title %}Payment Setup - Hospital Registration{% endblock %}

{% block content %}
<div class="container" style="max-width: 1000px; margin-top: 2rem;">
    <div class="card">
        <div class="card-header" style="text-align: center;">
            <h2 class="card-title">Secure Payment Options</h2>
            <p style="color: var(--text-light); margin-top: 0.5rem; font-size: 1.1rem;">
                Pay securely using UPI. We accept all major payment apps.
            </p>
        </div>
        
        <div style="padding: 2rem;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 3rem; align-items: center;">
                <!-- QR Code Section -->
                <div style="text-align: center;">
                    <h3 style="font-size: 1.75rem; color: var(--text-dark); margin-bottom: 1.5rem; font-weight: 600;">
                        Scan QR Code to Pay
                    </h3>
                    <div style="background: white; padding: 1.5rem; border: 4px solid var(--primary-color); border-radius: 0.75rem; display: inline-block; box-shadow: var(--shadow);">
                        <div id="hospital-payment-qr-code" style="width: 250px; height: 250px; background: #f9fafb; border-radius: 0.5rem; display: flex; align-items: center; justify-content: center; color: var(--text-light);">
                            <div style="text-align: center;">
                                <div class="spinner" style="margin: 0 auto 1rem;"></div>
                                <p>Loading QR Code...</p>
                            </div>
                        </div>
                    </div>
                    <p style="margin-top: 1.5rem; color: var(--text-light); font-size: 0.95rem;">
                        Scan with any UPI app to make payment
                    </p>
                </div>
                
                <!-- Payment Apps Section -->
                <div>
                    <h3 style="font-size: 1.75rem; color: var(--text-dark); margin-bottom: 1.5rem; font-weight: 600;">
                        Or Pay Directly
                    </h3>
                    <p style="color: var(--text-light); margin-bottom: 2rem; font-size: 1rem;">
                        Click on your preferred payment app to pay instantly
                    </p>
                    
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.5rem; margin-bottom: 2rem;">
                        <a href="#" onclick="openUPIApp('gpay')" class="upi-app-homepage" style="text-decoration: none; display: block;">
                            <div style="background: white; border: 2px solid var(--border-color); border-radius: 0.75rem; padding: 1.5rem; text-align: center; transition: all 0.3s; cursor: pointer;">
                                <div style="font-size: 3rem; margin-bottom: 0.75rem;">üì±</div>
                                <div style="font-weight: 600; color: var(--text-dark); font-size: 1rem;">Google Pay</div>
                                <div style="font-size: 0.75rem; color: var(--text-light); margin-top: 0.5rem;">Tap to Pay</div>
                            </div>
                        </a>
                        
                        <a href="#" onclick="openUPIApp('phonepay')" class="upi-app-homepage" style="text-decoration: none; display: block;">
                            <div style="background: white; border: 2px solid var(--border-color); border-radius: 0.75rem; padding: 1.5rem; text-align: center; transition: all 0.3s; cursor: pointer;">
                                <div style="font-size: 3rem; margin-bottom: 0.75rem;">üí≥</div>
                                <div style="font-weight: 600; color: var(--text-dark); font-size: 1rem;">PhonePe</div>
                                <div style="font-size: 0.75rem; color: var(--text-light); margin-top: 0.5rem;">Tap to Pay</div>
                            </div>
                        </a>
                        
                        <a href="#" onclick="openUPIApp('paytm')" class="upi-app-homepage" style="text-decoration: none; display: block;">
                            <div style="background: white; border: 2px solid var(--border-color); border-radius: 0.75rem; padding: 1.5rem; text-align: center; transition: all 0.3s; cursor: pointer;">
                                <div style="font-size: 3rem; margin-bottom: 0.75rem;">üíµ</div>
                                <div style="font-weight: 600; color: var(--text-dark); font-size: 1rem;">Paytm</div>
                                <div style="font-size: 0.75rem; color: var(--text-light); margin-top: 0.5rem;">Tap to Pay</div>
                            </div>
                        </a>
                        
                        <a href="#" onclick="openUPIApp('bhimupi')" class="upi-app-homepage" style="text-decoration: none; display: block;">
                            <div style="background: white; border: 2px solid var(--border-color); border-radius: 0.75rem; padding: 1.5rem; text-align: center; transition: all 0.3s; cursor: pointer;">
                                <div style="font-size: 3rem; margin-bottom: 0.75rem;">üè¶</div>
                                <div style="font-weight: 600; color: var(--text-dark); font-size: 1rem;">BHIM UPI</div>
                                <div style="font-size: 0.75rem; color: var(--text-light); margin-top: 0.5rem;">Tap to Pay</div>
                            </div>
                        </a>
                    </div>
                    
                    <div style="padding: 1rem; background: var(--bg-light); border-radius: 0.5rem; text-align: center;">
                        <p style="color: var(--text-dark); font-weight: 600; margin-bottom: 0.5rem;">UPI ID</p>
                        <p style="color: var(--primary-color); font-family: monospace; font-size: 1.1rem; font-weight: 600;" id="hospital-payment-upi-id">hospital@upi</p>
                        <p style="color: var(--text-light); font-size: 0.875rem; margin-top: 0.5rem;">You can also pay using this UPI ID</p>
                    </div>
                </div>
            </div>
            
              <!-- WhatsApp Integration Section -->
              <div style="margin-top: 3rem; padding-top: 2rem; border-top: 2px solid var(--border-color);">
                  <h3 style="font-size: 1.5rem; color: var(--text-dark); margin-bottom: 1rem; font-weight: 600; text-align: center;">
                      üì± WhatsApp Integration
                  </h3>
                  <p style="color: var(--text-light); margin-bottom: 1.5rem; text-align: center; font-size: 0.95rem;">
                      Connect your WhatsApp to send automatic appointment confirmations and reminders to patients.
                  </p>
                  
                  <div id="whatsapp-setup-section" style="background: var(--bg-light); padding: 1.5rem; border-radius: 0.75rem; margin-bottom: 1.5rem;">
                      <div id="whatsapp-status-display" style="text-align: center; margin-bottom: 1rem;">
                          <p id="whatsapp-status-text" style="color: var(--text-dark); font-weight: 600; margin-bottom: 0.5rem;">Status: Not Initialized</p>
                          <p id="whatsapp-status-detail" style="color: var(--text-light); font-size: 0.875rem;">Click below to initialize WhatsApp</p>
                      </div>
                      
                      <div style="text-align: center;">
                          <button id="init-whatsapp-btn" onclick="initializeWhatsApp()" class="btn btn-primary" style="font-size: 1rem; padding: 0.875rem 2rem; margin: 0.5rem;">
                              Initialize WhatsApp
                          </button>
                          <button id="check-status-btn" onclick="checkWhatsAppStatus()" class="btn btn-outline" style="font-size: 1rem; padding: 0.875rem 2rem; margin: 0.5rem; display: none;">
                              Check Status
                          </button>
                      </div>
                      
                      <div id="whatsapp-instructions" style="display: none; margin-top: 1.5rem; padding: 1rem; background: white; border-radius: 0.5rem; border-left: 4px solid var(--primary-color);">
                          <p style="color: var(--text-dark); font-weight: 600; margin-bottom: 0.75rem;">üìã Instructions:</p>
                          <ol style="color: var(--text-light); font-size: 0.875rem; line-height: 1.8; padding-left: 1.5rem;">
                              <li>A browser window will open automatically</li>
                              <li>Scan the QR code shown in the browser with your WhatsApp mobile app</li>
                              <li>Use your hospital's WhatsApp number to scan</li>
                              <li>Once scanned, WhatsApp will be connected automatically</li>
                              <li>You can close the browser window after scanning</li>
                          </ol>
                      </div>
                  </div>
              </div>

              <div style="margin-top: 3rem; padding-top: 2rem; border-top: 2px solid var(--border-color); text-align: center;">
                  <a href="/" class="btn btn-primary" style="font-size: 1rem; padding: 0.875rem 2rem;">
                      Continue to Homepage
                  </a>
                  <a href="/register-hospital" class="btn btn-outline" style="margin-left: 1rem; font-size: 1rem; padding: 0.875rem 2rem;">
                      Register Another Hospital
                  </a>
              </div>
        </div>
    </div>
</div>

<style>
.upi-app-homepage:hover > div {
    border-color: var(--primary-color);
    background: #f0f9ff;
    transform: translateY(-3px);
    box-shadow: var(--shadow-lg);
}

@media (max-width: 768px) {
    .container > .card > div[style*="grid-template-columns: 1fr 1fr"] {
        grid-template-columns: 1fr !important;
        gap: 2rem !important;
    }
}
</style>

<script>
// Store hospital UPI IDs
let hospitalUPIIds = {
    upi_id: 'hospital@upi',
    gpay_upi_id: 'hospital@upi',
    phonepay_upi_id: 'hospital@upi',
    paytm_upi_id: 'hospital@upi',
    bhim_upi_id: 'hospital@upi'
};

// Load payment QR code
async function loadHospitalPaymentQR() {
    const qrContainer = document.getElementById('hospital-payment-qr-code');
    const upiIdElement = document.getElementById('hospital-payment-upi-id');
    
    if (!qrContainer) return;
    
    try {
        // Get hospital ID from URL if available
        const urlParams = new URLSearchParams(window.location.search);
        const hospitalId = urlParams.get('hospital_id');
        
        // Fetch hospital payment info
        const paymentInfoUrl = hospitalId 
            ? `/api/hospitals/payment-info?hospital_id=${hospitalId}`
            : '/api/hospitals/payment-info';
        
        const paymentInfoResponse = await fetch(paymentInfoUrl);
        if (paymentInfoResponse.ok) {
            hospitalUPIIds = await paymentInfoResponse.json();
        }
        
        const defaultUpiId = hospitalUPIIds.upi_id || 'hospital@upi';
        const defaultAmount = '500';
        const transactionId = 'HOSP' + Date.now();
        
        // Generate QR code
        try {
            const response = await fetch('/api/payments/generate-qr', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    upi_id: defaultUpiId,
                    amount: defaultAmount,
                    transaction_id: transactionId
                })
            });
            
            if (response.ok) {
                const data = await response.json();
                qrContainer.innerHTML = `<img src="${data.qr_code}" alt="UPI QR Code" style="width: 100%; height: 100%; object-fit: contain; border-radius: 0.5rem;">`;
                if (upiIdElement) upiIdElement.textContent = defaultUpiId;
            } else {
                throw new Error('QR generation failed');
            }
        } catch (error) {
            // Fallback: Show placeholder
            qrContainer.innerHTML = `
                <div style="text-align: center; padding: 2rem;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">üí≥</div>
                    <p style="color: var(--text-dark); font-weight: 600;">UPI Payment</p>
                    <p style="color: var(--text-light); font-size: 0.875rem; margin-top: 0.5rem;">Scan with any UPI app</p>
                </div>
            `;
            if (upiIdElement) upiIdElement.textContent = defaultUpiId;
        }
    } catch (error) {
        console.error('Error loading payment QR:', error);
    }
}

function openUPIApp(appName) {
    const amount = '500';
    
    // Use app-specific UPI IDs
    const upiIdMap = {
        'gpay': hospitalUPIIds.gpay_upi_id || hospitalUPIIds.upi_id || 'hospital@upi',
        'phonepay': hospitalUPIIds.phonepay_upi_id || hospitalUPIIds.upi_id || 'hospital@upi',
        'paytm': hospitalUPIIds.paytm_upi_id || hospitalUPIIds.upi_id || 'hospital@upi',
        'bhimupi': hospitalUPIIds.bhim_upi_id || hospitalUPIIds.upi_id || 'hospital@upi'
    };
    
    const upiId = upiIdMap[appName] || hospitalUPIIds.upi_id || 'hospital@upi';
    
    const paymentLinks = {
        'gpay': `tez://pay?pa=${upiId}&am=${amount}&tn=Hospital%20Payment`,
        'phonepay': `phonepe://pay?pa=${upiId}&am=${amount}&tn=Hospital%20Payment`,
        'paytm': `paytmmp://pay?pa=${upiId}&am=${amount}&tn=Hospital%20Payment`,
        'bhimupi': `upi://pay?pa=${upiId}&am=${amount}&tn=Hospital%20Payment`
    };
    
    const link = paymentLinks[appName] || paymentLinks['bhimupi'];
    
    try {
        window.location.href = link;
        setTimeout(() => {
            alert(`If ${appName.charAt(0).toUpperCase() + appName.slice(1)} didn't open, please scan the QR code or use UPI ID: ${upiId}`);
        }, 1000);
    } catch (error) {
        console.error('Error opening UPI app:', error);
    }
}

  // Load payment QR on page load
  if (document.getElementById('hospital-payment-qr-code')) {
      loadHospitalPaymentQR();
  }

  // WhatsApp Integration Functions
  let currentHospitalId = null;

  // Get hospital ID from URL
  const urlParams = new URLSearchParams(window.location.search);
  currentHospitalId = urlParams.get('hospital_id');

  // Initialize WhatsApp
  async function initializeWhatsApp() {
      if (!currentHospitalId) {
          alert('Hospital ID not found. Please register a hospital first.');
          return;
      }

      const statusText = document.getElementById('whatsapp-status-text');
      const statusDetail = document.getElementById('whatsapp-status-detail');
      const initBtn = document.getElementById('init-whatsapp-btn');
      const checkBtn = document.getElementById('check-status-btn');
      const instructions = document.getElementById('whatsapp-instructions');

      try {
          // Disable button
          initBtn.disabled = true;
          initBtn.textContent = 'Initializing...';
          statusText.textContent = 'Status: Initializing...';
          statusText.style.color = 'var(--primary-color)';
          statusDetail.textContent = 'Please wait...';

          // Enable WhatsApp first
          const enableResponse = await fetch(`/api/hospitals/${currentHospitalId}/whatsapp-settings`, {
              method: 'PUT',
              headers: {
                  'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                  whatsapp_enabled: 'true'
              })
          });

          if (!enableResponse.ok) {
              throw new Error('Failed to enable WhatsApp');
          }

          // Initialize WhatsApp session
          const initResponse = await fetch(`/api/hospitals/${currentHospitalId}/whatsapp-init`, {
              method: 'POST',
              headers: {
                  'Content-Type': 'application/json'
              }
          });

          const initData = await initResponse.json();

          if (initResponse.ok) {
              statusText.textContent = 'Status: Initialization Started!';
              statusText.style.color = 'var(--success-color)';
              statusDetail.textContent = 'A browser window should open. Please scan the QR code with your WhatsApp mobile app.';
              
              // Show instructions
              instructions.style.display = 'block';
              
              // Show check status button
              checkBtn.style.display = 'inline-block';
              initBtn.textContent = 'Re-initialize';
              initBtn.disabled = false;

              // Check status after delay
              setTimeout(() => {
                  checkWhatsAppStatus();
              }, 5000);
          } else {
              throw new Error(initData.detail || 'Failed to initialize WhatsApp');
          }
      } catch (error) {
          statusText.textContent = 'Status: Error';
          statusText.style.color = 'var(--danger-color)';
          statusDetail.textContent = `Error: ${error.message}`;
          initBtn.disabled = false;
          initBtn.textContent = 'Try Again';
          alert(`WhatsApp initialization failed: ${error.message}`);
      }
  }

  // Check WhatsApp status
  async function checkWhatsAppStatus() {
      if (!currentHospitalId) return;

      const statusText = document.getElementById('whatsapp-status-text');
      const statusDetail = document.getElementById('whatsapp-status-detail');
      const checkBtn = document.getElementById('check-status-btn');

      try {
          checkBtn.disabled = true;
          checkBtn.textContent = 'Checking...';

          const response = await fetch(`/api/hospitals/${currentHospitalId}/whatsapp-status`);
          const data = await response.json();

          if (data.session_active) {
              statusText.textContent = 'Status: ‚úÖ Connected';
              statusText.style.color = 'var(--success-color)';
              statusDetail.textContent = 'WhatsApp is connected and ready to send messages!';
              document.getElementById('whatsapp-instructions').style.display = 'none';
          } else {
              statusText.textContent = 'Status: ‚è≥ Waiting for QR Scan';
              statusText.style.color = 'var(--warning-color)';
              statusDetail.textContent = 'Please scan the QR code in the browser window to connect WhatsApp.';
          }
      } catch (error) {
          statusText.textContent = 'Status: Error';
          statusText.style.color = 'var(--danger-color)';
          statusDetail.textContent = `Error checking status: ${error.message}`;
      } finally {
          checkBtn.disabled = false;
          checkBtn.textContent = 'Check Status';
      }
  }

  // Check status on page load if hospital ID exists
  if (currentHospitalId) {
      checkWhatsAppStatus();
  }
</script>
{% endblock %}

