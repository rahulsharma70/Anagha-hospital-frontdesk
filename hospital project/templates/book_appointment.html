{% extends "base.html" %}

{% block title %}Book Appointment - Hospital Booking System{% endblock %}

{% block content %}
<div class="container" style="max-width: 800px; margin-top: 2rem;">
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Book Appointment</h2>
        </div>
        
        <div id="alert-container"></div>
        
        <form id="appointmentForm">
            <div class="form-group">
                <label class="form-label" for="doctor_id">Select Doctor</label>
                <select class="form-control" id="doctor_id" name="doctor_id" required>
                    <option value="">Loading doctors...</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="date">Appointment Date</label>
                <input type="date" class="form-control" id="date" name="date" required>
            </div>
            
            <div class="form-group">
                <label class="form-label">Select Time Slot</label>
                <div id="time-slots-container"></div>
                <input type="hidden" id="time_slot" name="time_slot" required>
            </div>
            
            <button type="submit" class="btn btn-primary" style="width: 100%;">Book Appointment</button>
        </form>
    </div>
</div>

<script>
const token = localStorage.getItem('authToken');

// Load doctors
async function loadDoctors() {
    try {
        const response = await fetch('/api/users/doctors', {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (response.ok) {
            const doctors = await response.json();
            const select = document.getElementById('doctor_id');
            select.innerHTML = '<option value="">Select a doctor</option>';
            
            doctors.forEach(doctor => {
                const option = document.createElement('option');
                option.value = doctor.id;
                option.textContent = doctor.name;
                select.appendChild(option);
            });
        }
    } catch (error) {
        console.error('Error loading doctors:', error);
    }
}

// Load available slots when date and doctor are selected
document.getElementById('date').addEventListener('change', loadAvailableSlots);
document.getElementById('doctor_id').addEventListener('change', loadAvailableSlots);

async function loadAvailableSlots() {
    const doctorId = document.getElementById('doctor_id').value;
    const date = document.getElementById('date').value;
    
    if (!doctorId || !date) {
        return;
    }
    
    try {
        const response = await fetch(`/api/appointments/available-slots?doctor_id=${doctorId}&appointment_date=${date}`, {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (response.ok) {
            const data = await response.json();
            initializeTimeSlots('time-slots-container', null, data.booked_slots);
        }
    } catch (error) {
        console.error('Error loading slots:', error);
    }
}

// Submit form
document.getElementById('appointmentForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const doctorId = document.getElementById('doctor_id').value;
    const date = document.getElementById('date').value;
    const timeSlot = document.getElementById('time_slot').value;
    const alertContainer = document.getElementById('alert-container');
    
    if (!timeSlot) {
        alertContainer.innerHTML = '<div class="alert alert-error">Please select a time slot</div>';
        return;
    }
    
    try {
        const response = await fetch('/api/appointments/book', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({
                doctor_id: parseInt(doctorId),
                date: date,
                time_slot: timeSlot
            })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            // Redirect to payment page
            window.location.href = `/payment/${data.id}`;
        } else {
            alertContainer.innerHTML = `<div class="alert alert-error">${data.detail || 'Failed to book appointment'}</div>`;
        }
    } catch (error) {
        alertContainer.innerHTML = `<div class="alert alert-error">${error.message}</div>`;
    }
});

// Check authentication
if (!token) {
    window.location.href = '/login';
} else {
    loadDoctors();
    // Set minimum date to tomorrow
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    document.getElementById('date').min = tomorrow.toISOString().split('T')[0];
}
</script>
{% endblock %}

