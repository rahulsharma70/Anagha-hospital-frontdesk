{% extends "base.html" %}

{% block title %}Dashboard - Hospital Booking System{% endblock %}

{% block content %}
<div class="container" style="margin-top: 2rem;">
    <div class="card">
        <h1 class="card-title">Welcome, <span id="user-name">User</span>!</h1>
        <p style="color: var(--text-light); margin-top: 0.5rem;">
            Role: <strong><span id="user-role">-</span></strong>
        </p>
    </div>
    
    <div class="dashboard-grid">
        <div class="dashboard-card">
            <h3>My Appointments</h3>
            <div class="number" id="appointment-count">-</div>
        </div>
        
        <div class="dashboard-card">
            <h3>My Operations</h3>
            <div class="number" id="operation-count">-</div>
        </div>
        
        <div class="dashboard-card">
            <h3>Quick Actions</h3>
            <div style="margin-top: 1rem;">
                <a href="/book-appointment" class="btn btn-primary" style="display: block; margin-bottom: 0.5rem;">Book Appointment</a>
                <a href="/book-operation" class="btn btn-secondary" style="display: block;">Book Operation</a>
            </div>
        </div>
    </div>
    
    <div class="card" style="margin-top: 2rem;">
        <div class="card-header">
            <h2 class="card-title">My Appointments</h2>
        </div>
        <div id="appointments-container">
            <div class="spinner"></div>
        </div>
    </div>
    
    <div class="card" style="margin-top: 2rem;">
        <div class="card-header">
            <h2 class="card-title">My Operations</h2>
        </div>
        <div id="operations-container">
            <div class="spinner"></div>
        </div>
    </div>
</div>

<script>
const token = localStorage.getItem('authToken');

// Load user information
async function loadUserInfo() {
    try {
        const response = await fetch('/api/users/me', {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (response.ok) {
            const user = await response.json();
            document.getElementById('user-name').textContent = user.name || 'User';
            document.getElementById('user-role').textContent = (user.role || '-').charAt(0).toUpperCase() + (user.role || '').slice(1);
        }
    } catch (error) {
        console.error('Error loading user info:', error);
    }
}

async function loadDashboard() {
    try {
        // Load appointments
        const appointmentsResponse = await fetch('/api/appointments/my-appointments', {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (appointmentsResponse.ok) {
            const appointments = await appointmentsResponse.json();
            document.getElementById('appointment-count').textContent = appointments.length;
            displayAppointments(appointments);
        }
        
        // Load operations
        const operationsResponse = await fetch('/api/operations/my-operations', {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (operationsResponse.ok) {
            const operations = await operationsResponse.json();
            document.getElementById('operation-count').textContent = operations.length;
            displayOperations(operations);
        }
    } catch (error) {
        console.error('Error loading dashboard:', error);
    }
}

function displayAppointments(appointments) {
    const container = document.getElementById('appointments-container');
    
    if (appointments.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: var(--text-light);">No appointments found</p>';
        return;
    }
    
    let html = '<table class="table"><thead><tr><th>Date</th><th>Time</th><th>Doctor</th><th>Status</th><th>Action</th></tr></thead><tbody>';
    
    appointments.forEach(apt => {
        const date = new Date(apt.date).toLocaleDateString();
        const time = formatTimeSlot(apt.time_slot);
        const statusClass = apt.status === 'confirmed' ? 'confirmed' : 
                           apt.status === 'cancelled' ? 'cancelled' : 'pending';
        
        html += `
            <tr>
                <td>${date}</td>
                <td>${time}</td>
                <td>${apt.doctor_name || 'N/A'}</td>
                <td><span class="badge badge-${statusClass}">${apt.status}</span></td>
                <td>
                    ${apt.status !== 'cancelled' ? 
                        `<button class="btn btn-danger" onclick="cancelAppointment(${apt.id})" style="padding: 0.5rem 1rem; font-size: 0.875rem;">Cancel</button>` 
                        : ''}
                </td>
            </tr>
        `;
    });
    
    html += '</tbody></table>';
    container.innerHTML = html;
}

function displayOperations(operations) {
    const container = document.getElementById('operations-container');
    
    if (operations.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: var(--text-light);">No operations found</p>';
        return;
    }
    
    let html = '<table class="table"><thead><tr><th>Date</th><th>Specialty</th><th>Doctor</th><th>Status</th><th>Action</th></tr></thead><tbody>';
    
    operations.forEach(op => {
        const date = new Date(op.date).toLocaleDateString();
        const statusClass = op.status === 'confirmed' ? 'confirmed' : 
                           op.status === 'cancelled' ? 'cancelled' : 'pending';
        
        html += `
            <tr>
                <td>${date}</td>
                <td>${op.specialty.toUpperCase()}</td>
                <td>${op.doctor_name || 'N/A'}</td>
                <td><span class="badge badge-${statusClass}">${op.status}</span></td>
                <td>
                    ${op.status !== 'cancelled' ? 
                        `<button class="btn btn-danger" onclick="cancelOperation(${op.id})" style="padding: 0.5rem 1rem; font-size: 0.875rem;">Cancel</button>` 
                        : ''}
                </td>
            </tr>
        `;
    });
    
    html += '</tbody></table>';
    container.innerHTML = html;
}

async function cancelAppointment(id) {
    if (!confirm('Are you sure you want to cancel this appointment?')) return;
    
    try {
        const response = await fetch(`/api/appointments/${id}/cancel`, {
            method: 'PUT',
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (response.ok) {
            alert('Appointment cancelled successfully');
            loadDashboard();
        } else {
            alert('Failed to cancel appointment');
        }
    } catch (error) {
        alert('Error cancelling appointment');
    }
}

async function cancelOperation(id) {
    if (!confirm('Are you sure you want to cancel this operation?')) return;
    
    try {
        const response = await fetch(`/api/operations/${id}/cancel`, {
            method: 'PUT',
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (response.ok) {
            alert('Operation cancelled successfully');
            loadDashboard();
        } else {
            alert('Failed to cancel operation');
        }
    } catch (error) {
        alert('Error cancelling operation');
    }
}

function formatTimeSlot(timeSlot) {
    const [hours, minutes] = timeSlot.split(':');
    const hour = parseInt(hours);
    const ampm = hour >= 12 ? 'PM' : 'AM';
    const displayHour = hour % 12 || 12;
    return `${displayHour}:${minutes} ${ampm}`;
}

// Check authentication
if (!token) {
    window.location.href = '/login';
} else {
    loadUserInfo();
    loadDashboard();
}
</script>
{% endblock %}

