{% extends "base.html" %}

{% block title %}Register - Hospital Booking System{% endblock %}

{% block content %}
<div class="container" style="max-width: 800px; margin-top: 4rem;">
    <div class="card">
        <div class="card-header">
            <h2 class="card-title text-center">Register</h2>
        </div>
        
        <div id="alert-container"></div>
        
        <form id="registerForm">
            <div class="form-group">
                <label class="form-label" for="name">Full Name</label>
                <input type="text" class="form-control" id="name" name="name" required 
                       placeholder="Enter your full name">
            </div>
            
            <div class="form-group">
                <label class="form-label" for="mobile">Mobile Number</label>
                <input type="text" class="form-control" id="mobile" name="mobile" required 
                       placeholder="Enter your mobile number">
            </div>
            
            <div class="form-group">
                <label class="form-label" for="role">I am a <span style="color: var(--danger-color);">*</span></label>
                <select class="form-control" id="role" name="role" required onchange="toggleRoleFields()">
                    <option value="">Select role</option>
                    <option value="patient">Patient</option>
                    <option value="pharma">Pharma Professional</option>
                    <option value="doctor">Doctor</option>
                </select>
            </div>
            
            <div class="form-group" id="hospital-group" style="display: none;">
                <label class="form-label" for="hospital_id">Select Hospital <span style="color: var(--danger-color);">*</span></label>
                <select class="form-control" id="hospital_id" name="hospital_id" required>
                    <option value="">Select hospital</option>
                </select>
                <small style="color: var(--text-light);">Only approved hospitals are shown</small>
            </div>
            
            <!-- Pharma Professional Fields -->
            <div id="pharma-fields" style="display: none;">
                <h3 style="margin-top: 1.5rem; margin-bottom: 1rem; color: var(--primary-color);">Pharma Professional Details</h3>
                
                <div class="form-group">
                    <label class="form-label" for="company_name">Company Name <span style="color: var(--danger-color);">*</span></label>
                    <input type="text" class="form-control" id="company_name" name="company_name" 
                           placeholder="Enter company name">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Products (for reminders if appointment cancelled by Dr)</label>
                    <input type="text" class="form-control" id="product1" name="product1" 
                           placeholder="Product 1" style="margin-bottom: 0.5rem;">
                    <input type="text" class="form-control" id="product2" name="product2" 
                           placeholder="Product 2" style="margin-bottom: 0.5rem;">
                    <input type="text" class="form-control" id="product3" name="product3" 
                           placeholder="Product 3" style="margin-bottom: 0.5rem;">
                    <input type="text" class="form-control" id="product4" name="product4" 
                           placeholder="Product 4">
                </div>
            </div>
            
            <!-- Doctor Fields -->
            <div id="doctor-fields" style="display: none;">
                <h3 style="margin-top: 1.5rem; margin-bottom: 1rem; color: var(--primary-color);">Doctor Details</h3>
                
                <div class="form-group">
                    <label class="form-label" for="degree">Degree <span style="color: var(--danger-color);">*</span></label>
                    <input type="text" class="form-control" id="degree" name="degree" 
                           placeholder="e.g., MBBS, MD, MS, etc.">
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="institute_name">Institute Name <span style="color: var(--danger-color);">*</span></label>
                    <input type="text" class="form-control" id="institute_name" name="institute_name" 
                           placeholder="Name of the institute/university">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Experience Details</label>
                    <textarea class="form-control" id="experience1" name="experience1" rows="2" 
                              placeholder="Experience 1"></textarea>
                    <textarea class="form-control" id="experience2" name="experience2" rows="2" 
                              placeholder="Experience 2" style="margin-top: 0.5rem;"></textarea>
                    <textarea class="form-control" id="experience3" name="experience3" rows="2" 
                              placeholder="Experience 3" style="margin-top: 0.5rem;"></textarea>
                    <textarea class="form-control" id="experience4" name="experience4" rows="2" 
                              placeholder="Experience 4" style="margin-top: 0.5rem;"></textarea>
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="address_line1">Address Line 1</label>
                <input type="text" class="form-control" id="address_line1" name="address_line1" 
                       placeholder="Street address">
            </div>
            
            <div class="form-group">
                <label class="form-label" for="address_line2">Address Line 2</label>
                <input type="text" class="form-control" id="address_line2" name="address_line2" 
                       placeholder="Area/Locality">
            </div>
            
            <div class="form-group">
                <label class="form-label" for="address_line3">Address Line 3</label>
                <input type="text" class="form-control" id="address_line3" name="address_line3" 
                       placeholder="City, State, PIN">
            </div>
            
            <div class="form-group">
                <label class="form-label" for="password">Password</label>
                <input type="password" class="form-control" id="password" name="password" required 
                       placeholder="Enter password (min 6 characters)">
            </div>
            
            <div class="form-group">
                <label class="form-label" for="confirm_password">Confirm Password</label>
                <input type="password" class="form-control" id="confirm_password" name="confirm_password" required 
                       placeholder="Confirm your password">
            </div>
            
            <button type="submit" class="btn btn-primary" style="width: 100%;">Register</button>
        </form>
        
        <div style="text-align: center; margin-top: 1.5rem;">
            <p style="color: var(--text-light);">
                Already have an account? <a href="/login" style="color: var(--primary-color);">Login here</a>
            </p>
            <p style="color: var(--text-light); margin-top: 0.5rem;">
                Want to register your hospital? <a href="/register-hospital" style="color: var(--primary-color);">Register Hospital</a>
            </p>
        </div>
    </div>
</div>

<script>
// Load approved hospitals
async function loadHospitals() {
    try {
        const response = await fetch('/api/hospitals/approved');
        if (response.ok) {
            const hospitals = await response.json();
            const select = document.getElementById('hospital_id');
            select.innerHTML = '<option value="">Select hospital (optional)</option>';
            hospitals.forEach(hospital => {
                const option = document.createElement('option');
                option.value = hospital.id;
                option.textContent = hospital.name;
                select.appendChild(option);
            });
        }
    } catch (error) {
        console.error('Error loading hospitals:', error);
    }
}

// Toggle role-specific fields
function toggleRoleFields() {
    const role = document.getElementById('role').value;
    const pharmaFields = document.getElementById('pharma-fields');
    const doctorFields = document.getElementById('doctor-fields');
    const hospitalGroup = document.getElementById('hospital-group');
    
    // Hide all fields first
    pharmaFields.style.display = 'none';
    doctorFields.style.display = 'none';
    hospitalGroup.style.display = 'none';
    
    // Show relevant fields
    if (role === 'pharma') {
        pharmaFields.style.display = 'block';
        hospitalGroup.style.display = 'block';
        document.getElementById('hospital_id').required = true;
    } else if (role === 'doctor') {
        doctorFields.style.display = 'block';
        hospitalGroup.style.display = 'block';
        document.getElementById('hospital_id').required = false;
    } else if (role === 'patient') {
        hospitalGroup.style.display = 'block';
        document.getElementById('hospital_id').required = true;
    }
}

// Load hospitals on page load
loadHospitals();

document.getElementById('registerForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const password = document.getElementById('password').value;
    const confirmPassword = document.getElementById('confirm_password').value;
    const role = document.getElementById('role').value;
    const alertContainer = document.getElementById('alert-container');
    
    if (!role) {
        alertContainer.innerHTML = '<div class="alert alert-error">Please select a role</div>';
        return;
    }
    
    if (password !== confirmPassword) {
        alertContainer.innerHTML = '<div class="alert alert-error">Passwords do not match</div>';
        return;
    }
    
    if (password.length < 6) {
        alertContainer.innerHTML = '<div class="alert alert-error">Password must be at least 6 characters</div>';
        return;
    }
    
    // Validate role-specific required fields
    if (role === 'pharma') {
        const companyName = document.getElementById('company_name').value;
        if (!companyName) {
            alertContainer.innerHTML = '<div class="alert alert-error">Company name is required for pharma professionals</div>';
            return;
        }
        const hospitalId = document.getElementById('hospital_id').value;
        if (!hospitalId) {
            alertContainer.innerHTML = '<div class="alert alert-error">Hospital selection is required for pharma professionals</div>';
            return;
        }
    }
    
    if (role === 'patient') {
        const hospitalId = document.getElementById('hospital_id').value;
        if (!hospitalId) {
            alertContainer.innerHTML = '<div class="alert alert-error">Hospital selection is required for patients</div>';
            return;
        }
    }
    
    if (role === 'doctor') {
        const degree = document.getElementById('degree').value;
        const institute = document.getElementById('institute_name').value;
        if (!degree || !institute) {
            alertContainer.innerHTML = '<div class="alert alert-error">Degree and institute name are required for doctors</div>';
            return;
        }
    }
    
    const formData = {
        name: document.getElementById('name').value,
        mobile: document.getElementById('mobile').value,
        role: role,
        address_line1: document.getElementById('address_line1').value,
        address_line2: document.getElementById('address_line2').value,
        address_line3: document.getElementById('address_line3').value,
        password: password
    };
    
    // Add hospital_id (required for patient and pharma)
    const hospitalId = document.getElementById('hospital_id').value;
    if (hospitalId) {
        formData.hospital_id = parseInt(hospitalId);
    } else if (role === 'patient' || role === 'pharma') {
        alertContainer.innerHTML = '<div class="alert alert-error">Hospital selection is required</div>';
        return;
    }
    
    // Add pharma fields
    if (role === 'pharma') {
        formData.company_name = document.getElementById('company_name').value;
        formData.product1 = document.getElementById('product1').value;
        formData.product2 = document.getElementById('product2').value;
        formData.product3 = document.getElementById('product3').value;
        formData.product4 = document.getElementById('product4').value;
    }
    
    // Add doctor fields
    if (role === 'doctor') {
        formData.degree = document.getElementById('degree').value;
        formData.institute_name = document.getElementById('institute_name').value;
        formData.experience1 = document.getElementById('experience1').value;
        formData.experience2 = document.getElementById('experience2').value;
        formData.experience3 = document.getElementById('experience3').value;
        formData.experience4 = document.getElementById('experience4').value;
    }
    
    try {
        const response = await fetch('/api/users/register', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
        });
        
        const data = await response.json();
        
        if (response.ok) {
            alertContainer.innerHTML = '<div class="alert alert-success">Registration successful! Redirecting to login...</div>';
            setTimeout(() => {
                window.location.href = '/login';
            }, 2000);
        } else {
            alertContainer.innerHTML = `<div class="alert alert-error">${data.detail || 'Registration failed'}</div>`;
        }
    } catch (error) {
        alertContainer.innerHTML = `<div class="alert alert-error">${error.message}</div>`;
    }
});
</script>
{% endblock %}
