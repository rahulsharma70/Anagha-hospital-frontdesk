{% extends "base.html" %}

{% block title %}Doctor Dashboard - Hospital Booking System{% endblock %}

{% block content %}
<div class="container" style="margin-top: 2rem;">
    <div class="card">
        <h1 class="card-title">Doctor Dashboard</h1>
        <p style="color: var(--text-light); margin-top: 0.5rem;">
            Welcome, Dr. <span id="user-name">Doctor</span>!
        </p>
    </div>
    
    <div class="dashboard-grid">
        <div class="dashboard-card">
            <h3>Pending Appointments</h3>
            <div class="number" id="pending-appointments">-</div>
        </div>
        
        <div class="dashboard-card">
            <h3>Total Appointments</h3>
            <div class="number" id="total-appointments">-</div>
        </div>
        
        <div class="dashboard-card">
            <h3>Pending Operations</h3>
            <div class="number" id="pending-operations">-</div>
        </div>
        
        <div class="dashboard-card">
            <h3>Total Operations</h3>
            <div class="number" id="total-operations">-</div>
        </div>
    </div>
    
    <div class="card" style="margin-top: 2rem;">
        <div class="card-header">
            <h2 class="card-title">My Appointments</h2>
        </div>
        <div id="appointments-container">
            <div class="spinner"></div>
        </div>
    </div>
    
    <div class="card" style="margin-top: 2rem;">
        <div class="card-header">
            <h2 class="card-title">My Operations</h2>
        </div>
        <div id="operations-container">
            <div class="spinner"></div>
        </div>
    </div>
</div>

<script>
const token = localStorage.getItem('authToken');

// Load user information
async function loadUserInfo() {
    try {
        const response = await fetch('/api/users/me', {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (response.ok) {
            const user = await response.json();
            document.getElementById('user-name').textContent = user.name || 'Doctor';
        }
    } catch (error) {
        console.error('Error loading user info:', error);
    }
}

async function loadDoctorDashboard() {
    try {
        // Load appointments
        const appointmentsResponse = await fetch('/api/appointments/doctor-appointments', {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (appointmentsResponse.ok) {
            const appointments = await appointmentsResponse.json();
            document.getElementById('total-appointments').textContent = appointments.length;
            document.getElementById('pending-appointments').textContent = 
                appointments.filter(a => a.status === 'pending').length;
            displayAppointments(appointments);
        }
        
        // Load operations
        const operationsResponse = await fetch('/api/operations/doctor-operations', {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (operationsResponse.ok) {
            const operations = await operationsResponse.json();
            document.getElementById('total-operations').textContent = operations.length;
            document.getElementById('pending-operations').textContent = 
                operations.filter(o => o.status === 'pending').length;
            displayOperations(operations);
        }
    } catch (error) {
        console.error('Error loading dashboard:', error);
    }
}

function displayAppointments(appointments) {
    const container = document.getElementById('appointments-container');
    
    if (appointments.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: var(--text-light);">No appointments found</p>';
        return;
    }
    
    let html = '<table class="table"><thead><tr><th>Date</th><th>Time</th><th>Patient</th><th>Status</th><th>Actions</th></tr></thead><tbody>';
    
    appointments.forEach(apt => {
        const date = new Date(apt.date).toLocaleDateString();
        const time = formatTimeSlot(apt.time_slot);
        const statusClass = apt.status === 'confirmed' ? 'confirmed' : 
                           apt.status === 'cancelled' ? 'cancelled' : 'pending';
        
        html += `
            <tr>
                <td>${date}</td>
                <td>${time}</td>
                <td>${apt.user_name || 'N/A'}</td>
                <td><span class="badge badge-${statusClass}">${apt.status}</span></td>
                <td>
                    ${apt.status === 'pending' ? 
                        `<button class="btn btn-secondary" onclick="confirmAppointment(${apt.id})" style="padding: 0.5rem 1rem; font-size: 0.875rem; margin-right: 0.5rem;">Confirm</button>` 
                        : ''}
                    ${apt.status !== 'cancelled' ? 
                        `<button class="btn btn-danger" onclick="cancelAppointment(${apt.id})" style="padding: 0.5rem 1rem; font-size: 0.875rem;">Cancel</button>` 
                        : ''}
                </td>
            </tr>
        `;
    });
    
    html += '</tbody></table>';
    container.innerHTML = html;
}

function displayOperations(operations) {
    const container = document.getElementById('operations-container');
    
    if (operations.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: var(--text-light);">No operations found</p>';
        return;
    }
    
    let html = '<table class="table"><thead><tr><th>Date</th><th>Specialty</th><th>Patient</th><th>Status</th><th>Actions</th></tr></thead><tbody>';
    
    operations.forEach(op => {
        const date = new Date(op.date).toLocaleDateString();
        const statusClass = op.status === 'confirmed' ? 'confirmed' : 
                           op.status === 'cancelled' ? 'cancelled' : 'pending';
        
        html += `
            <tr>
                <td>${date}</td>
                <td>${op.specialty.toUpperCase()}</td>
                <td>${op.patient_name || 'N/A'}</td>
                <td><span class="badge badge-${statusClass}">${op.status}</span></td>
                <td>
                    ${op.status === 'pending' ? 
                        `<button class="btn btn-secondary" onclick="confirmOperation(${op.id})" style="padding: 0.5rem 1rem; font-size: 0.875rem; margin-right: 0.5rem;">Confirm</button>` 
                        : ''}
                    ${op.status !== 'cancelled' ? 
                        `<button class="btn btn-danger" onclick="cancelOperation(${op.id})" style="padding: 0.5rem 1rem; font-size: 0.875rem;">Cancel</button>` 
                        : ''}
                </td>
            </tr>
        `;
    });
    
    html += '</tbody></table>';
    container.innerHTML = html;
}

async function confirmAppointment(id) {
    try {
        const response = await fetch(`/api/appointments/${id}/confirm`, {
            method: 'PUT',
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (response.ok) {
            alert('Appointment confirmed successfully');
            loadDoctorDashboard();
        } else {
            alert('Failed to confirm appointment');
        }
    } catch (error) {
        alert('Error confirming appointment');
    }
}

async function cancelAppointment(id) {
    if (!confirm('Are you sure you want to cancel this appointment?')) return;
    
    try {
        const response = await fetch(`/api/appointments/${id}/cancel`, {
            method: 'PUT',
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (response.ok) {
            alert('Appointment cancelled successfully');
            loadDoctorDashboard();
        } else {
            alert('Failed to cancel appointment');
        }
    } catch (error) {
        alert('Error cancelling appointment');
    }
}

async function confirmOperation(id) {
    try {
        const response = await fetch(`/api/operations/${id}/confirm`, {
            method: 'PUT',
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (response.ok) {
            alert('Operation confirmed successfully');
            loadDoctorDashboard();
        } else {
            alert('Failed to confirm operation');
        }
    } catch (error) {
        alert('Error confirming operation');
    }
}

async function cancelOperation(id) {
    if (!confirm('Are you sure you want to cancel this operation?')) return;
    
    try {
        const response = await fetch(`/api/operations/${id}/cancel`, {
            method: 'PUT',
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (response.ok) {
            alert('Operation cancelled successfully');
            loadDoctorDashboard();
        } else {
            alert('Failed to cancel operation');
        }
    } catch (error) {
        alert('Error cancelling operation');
    }
}

function formatTimeSlot(timeSlot) {
    const [hours, minutes] = timeSlot.split(':');
    const hour = parseInt(hours);
    const ampm = hour >= 12 ? 'PM' : 'AM';
    const displayHour = hour % 12 || 12;
    return `${displayHour}:${minutes} ${ampm}`;
}

// Check authentication
if (!token) {
    window.location.href = '/login';
} else {
    loadUserInfo();
    loadDoctorDashboard();
}
</script>
{% endblock %}

