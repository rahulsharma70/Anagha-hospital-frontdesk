{% extends "base.html" %}

{% block title %}Payment - Hospital Booking System{% endblock %}

{% block content %}
<div class="container" style="max-width: 900px; margin-top: 2rem;">
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Complete Payment</h2>
            <p style="color: var(--text-light); margin-top: 0.5rem;">Pay securely using UPI</p>
        </div>
        
        <div id="alert-container"></div>
        
        <div id="payment-container">
            <div style="text-align: center; padding: 2rem;">
                <div class="spinner"></div>
                <p style="margin-top: 1rem; color: var(--text-light);">Loading payment options...</p>
            </div>
        </div>
    </div>
</div>

<style>
.payment-method {
    background: white;
    border: 2px solid var(--border-color);
    border-radius: 0.75rem;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    transition: all 0.3s;
    cursor: pointer;
}

.payment-method:hover {
    border-color: var(--primary-color);
    box-shadow: var(--shadow-lg);
    transform: translateY(-2px);
}

.payment-method.selected {
    border-color: var(--primary-color);
    background: #eff6ff;
}

.qr-code-container {
    text-align: center;
    padding: 1.5rem;
    background: white;
    border-radius: 0.75rem;
    margin-top: 1rem;
}

.qr-code-container img {
    max-width: 250px;
    width: 100%;
    height: auto;
    border: 4px solid var(--border-color);
    border-radius: 0.5rem;
    padding: 1rem;
    background: white;
}

.upi-apps {
    display: flex;
    gap: 1rem;
    justify-content: center;
    margin-top: 1.5rem;
    flex-wrap: wrap;
}

.upi-app {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 1rem;
    border: 2px solid var(--border-color);
    border-radius: 0.5rem;
    min-width: 120px;
    transition: all 0.3s;
    cursor: pointer;
}

.upi-app:hover {
    border-color: var(--primary-color);
    background: #f9fafb;
}

.upi-app.selected {
    border-color: var(--primary-color);
    background: #eff6ff;
}

.upi-app-link {
    text-decoration: none;
    display: block;
}

.upi-app-link:hover .upi-app {
    border-color: var(--primary-color);
    background: #f0f9ff;
    transform: translateY(-3px);
    box-shadow: var(--shadow-lg);
}

.upi-app-icon {
    font-size: 2.5rem;
    margin-bottom: 0.5rem;
}

.upi-app-name {
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--text-dark);
}

.amount-display {
    font-size: 2rem;
    font-weight: 700;
    color: var(--primary-color);
    text-align: center;
    margin: 1.5rem 0;
}

.transaction-info {
    background: var(--bg-light);
    padding: 1rem;
    border-radius: 0.5rem;
    margin-top: 1rem;
    font-size: 0.875rem;
    color: var(--text-light);
}
</style>

<script>
const token = localStorage.getItem('authToken');
const appointmentId = {% if appointment_id %}{{ appointment_id }}{% else %}null{% endif %};
const operationId = {% if operation_id %}{{ operation_id }}{% else %}null{% endif %};
const paymentType = '{{ type }}';

let currentPaymentData = null;
let selectedUpiApp = null;

// Load payment options
async function loadPayment() {
    const container = document.getElementById('payment-container');
    
    // Check if we have appointment or operation ID
    if (!appointmentId && !operationId) {
        container.innerHTML = `
            <div class="alert alert-error">
                <strong>Error:</strong> No appointment or operation ID found. Please book an appointment or operation first.
            </div>
            <div style="margin-top: 1rem; text-align: center;">
                <a href="/book-appointment" class="btn btn-primary">Book Appointment</a>
                <a href="/book-operation" class="btn btn-outline" style="margin-left: 1rem;">Book Operation</a>
            </div>
        `;
        return;
    }
    
    try {
        const response = await fetch('/api/payments/create', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({
                appointment_id: appointmentId || null,
                operation_id: operationId || null,
                amount: '500' // Default amount, can be made configurable
            })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            currentPaymentData = data;
            displayPaymentOptions(data);
        } else {
            container.innerHTML = `
                <div class="alert alert-error">
                    <strong>Error:</strong> ${data.detail || 'Failed to load payment options'}
                </div>
                <div style="margin-top: 1rem; text-align: center;">
                    <a href="/dashboard" class="btn btn-outline">Go to Dashboard</a>
                </div>
            `;
            console.error('Payment API Error:', data);
        }
    } catch (error) {
        container.innerHTML = `
            <div class="alert alert-error">
                <strong>Error:</strong> ${error.message}
                <br><small>Please check your internet connection and try again.</small>
            </div>
            <div style="margin-top: 1rem; text-align: center;">
                <button class="btn btn-primary" onclick="loadPayment()">Retry</button>
                <a href="/dashboard" class="btn btn-outline" style="margin-left: 1rem;">Go to Dashboard</a>
            </div>
        `;
        console.error('Payment Load Error:', error);
    }
}

function displayPaymentOptions(data) {
    const container = document.getElementById('payment-container');
    
    // Validate data structure
    if (!data || !data.qr_codes) {
        container.innerHTML = `
            <div class="alert alert-error">
                <strong>Error:</strong> Invalid payment data received. Please try again.
            </div>
            <div style="margin-top: 1rem; text-align: center;">
                <button class="btn btn-primary" onclick="loadPayment()">Retry</button>
            </div>
        `;
        return;
    }
    
    container.innerHTML = `
        <div style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); padding: 2rem; border-radius: 0.75rem; margin-bottom: 2rem;">
            <div class="amount-display" style="font-size: 2.5rem; font-weight: 700; color: var(--primary-color); text-align: center; margin-bottom: 0.5rem;">
                ‚Çπ${data.amount}
            </div>
            <p style="text-align: center; color: var(--text-light); margin: 0;">Payment Amount</p>
        </div>
        
        <div class="transaction-info" style="background: var(--bg-light); padding: 1rem; border-radius: 0.5rem; margin-bottom: 2rem; text-align: center;">
            <strong style="color: var(--text-dark);">Transaction ID:</strong>
            <span style="color: var(--text-light); font-family: monospace; margin-left: 0.5rem;">${data.transaction_id}</span>
        </div>
        
        <!-- Universal QR Code Section - Always Visible -->
        <div style="background: white; padding: 2rem; border-radius: 0.75rem; box-shadow: var(--shadow-lg); margin-bottom: 2rem;">
            <h3 style="text-align: center; margin-bottom: 1.5rem; color: var(--text-dark); font-size: 1.5rem; font-weight: 600;">
                Scan QR Code to Pay
            </h3>
            <div style="display: flex; justify-content: center; margin-bottom: 1.5rem;">
                <div style="background: white; padding: 1.5rem; border: 4px solid var(--primary-color); border-radius: 0.75rem; box-shadow: var(--shadow);">
                    <img id="universal-qr-code" src="${data.qr_codes.gpay}" alt="UPI QR Code" style="max-width: 280px; width: 100%; height: auto; display: block;">
                </div>
            </div>
            <p style="text-align: center; color: var(--text-light); font-size: 0.95rem; margin-bottom: 1.5rem;">
                Scan this QR code with any UPI app (GPay, PhonePe, Paytm, BHIM) to complete payment
            </p>
            <div style="text-align: center; margin-bottom: 1rem;">
                <p style="color: var(--text-dark); font-weight: 600; margin-bottom: 0.5rem;">UPI ID: <span style="color: var(--primary-color); font-family: monospace;">${data.upi_id}</span></p>
                <p style="color: var(--text-light); font-size: 0.875rem;">You can also pay directly using this UPI ID</p>
            </div>
        </div>
        
        <!-- Payment Links Section -->
        <div style="background: white; padding: 2rem; border-radius: 0.75rem; box-shadow: var(--shadow-lg); margin-bottom: 2rem;">
            <h3 style="text-align: center; margin-bottom: 1.5rem; color: var(--text-dark); font-size: 1.5rem; font-weight: 600;">
                Or Pay Directly with Payment Links
            </h3>
            <p style="text-align: center; color: var(--text-light); font-size: 0.95rem; margin-bottom: 1.5rem;">
                Click on your preferred UPI app to open and pay directly
            </p>
            <div class="upi-apps" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 1.5rem; margin-bottom: 1rem;">
                <a href="${data.payment_links.gpay}" onclick="openPaymentLink('gpay', '${data.payment_links.gpay}')" class="upi-app-link" style="text-decoration: none; display: block;">
                    <div class="upi-app" style="cursor: pointer; transition: all 0.3s;">
                        <div class="upi-app-icon" style="font-size: 3rem; margin-bottom: 0.75rem;">üì±</div>
                        <div class="upi-app-name" style="font-weight: 600; color: var(--text-dark);">Google Pay</div>
                        <div style="font-size: 0.75rem; color: var(--text-light); margin-top: 0.5rem;">Tap to Pay</div>
                    </div>
                </a>
                <a href="${data.payment_links.phonepay}" onclick="openPaymentLink('phonepay', '${data.payment_links.phonepay}')" class="upi-app-link" style="text-decoration: none; display: block;">
                    <div class="upi-app" style="cursor: pointer; transition: all 0.3s;">
                        <div class="upi-app-icon" style="font-size: 3rem; margin-bottom: 0.75rem;">üí≥</div>
                        <div class="upi-app-name" style="font-weight: 600; color: var(--text-dark);">PhonePe</div>
                        <div style="font-size: 0.75rem; color: var(--text-light); margin-top: 0.5rem;">Tap to Pay</div>
                    </div>
                </a>
                <a href="${data.payment_links.paytm}" onclick="openPaymentLink('paytm', '${data.payment_links.paytm}')" class="upi-app-link" style="text-decoration: none; display: block;">
                    <div class="upi-app" style="cursor: pointer; transition: all 0.3s;">
                        <div class="upi-app-icon" style="font-size: 3rem; margin-bottom: 0.75rem;">üíµ</div>
                        <div class="upi-app-name" style="font-weight: 600; color: var(--text-dark);">Paytm</div>
                        <div style="font-size: 0.75rem; color: var(--text-light); margin-top: 0.5rem;">Tap to Pay</div>
                    </div>
                </a>
                <a href="${data.payment_links.bhimupi}" onclick="openPaymentLink('bhimupi', '${data.payment_links.bhimupi}')" class="upi-app-link" style="text-decoration: none; display: block;">
                    <div class="upi-app" style="cursor: pointer; transition: all 0.3s;">
                        <div class="upi-app-icon" style="font-size: 3rem; margin-bottom: 0.75rem;">üè¶</div>
                        <div class="upi-app-name" style="font-weight: 600; color: var(--text-dark);">BHIM UPI</div>
                        <div style="font-size: 0.75rem; color: var(--text-light); margin-top: 0.5rem;">Tap to Pay</div>
                    </div>
                </a>
            </div>
        </div>
        
        <!-- Action Buttons -->
        <div style="background: white; padding: 2rem; border-radius: 0.75rem; box-shadow: var(--shadow-lg); text-align: center;">
            <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                <button class="btn btn-primary" onclick="verifyPayment()" style="min-width: 150px; font-size: 1rem; padding: 0.875rem 1.5rem;">
                    ‚úì I've Paid
                </button>
                <button class="btn btn-outline" onclick="window.location.href='/dashboard'" style="min-width: 150px; font-size: 1rem; padding: 0.875rem 1.5rem;">
                    Pay Later
                </button>
            </div>
            <p style="margin-top: 1rem; color: var(--text-light); font-size: 0.875rem;">
                After completing payment, click "I've Paid" to verify your transaction
            </p>
        </div>
    `;
}

function openPaymentLink(appName, paymentLink) {
    // Try to open the payment link
    try {
        window.location.href = paymentLink;
        // Fallback: if app doesn't open, show message
        setTimeout(() => {
            const alertContainer = document.getElementById('alert-container');
            alertContainer.innerHTML = `
                <div class="alert alert-info">
                    If the app didn't open, please install ${appName.charAt(0).toUpperCase() + appName.slice(1)} or scan the QR code above.
                </div>
            `;
        }, 1000);
    } catch (error) {
        console.error('Error opening payment link:', error);
    }
}

function selectUpiApp(appName, qrCodeData) {
    selectedUpiApp = appName;
    
    // Update QR code image
    const qrImage = document.getElementById('universal-qr-code');
    if (qrImage) {
        qrImage.src = qrCodeData;
    }
    
    // Show alert
    const alertContainer = document.getElementById('alert-container');
    alertContainer.innerHTML = `
        <div class="alert alert-info">
            QR code updated for ${appName.charAt(0).toUpperCase() + appName.slice(1)}. Scan with any UPI app to pay.
        </div>
    `;
}

async function verifyPayment() {
    if (!currentPaymentData) return;
    
    const alertContainer = document.getElementById('alert-container');
    
    try {
        const response = await fetch(`/api/payments/verify/${currentPaymentData.payment_id}`, {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        const data = await response.json();
        
        if (response.ok) {
            if (data.status === 'completed') {
                alertContainer.innerHTML = '<div class="alert alert-success">Payment verified! Redirecting to dashboard...</div>';
                setTimeout(() => {
                    window.location.href = '/dashboard';
                }, 2000);
            } else {
                alertContainer.innerHTML = `
                    <div class="alert alert-info">
                        Payment is still pending. Please complete the payment and try again.
                        <br><small>If you've already paid, contact the hospital for manual verification.</small>
                    </div>
                `;
            }
        } else {
            alertContainer.innerHTML = `<div class="alert alert-error">${data.detail || 'Failed to verify payment'}</div>`;
        }
    } catch (error) {
        alertContainer.innerHTML = `<div class="alert alert-error">${error.message}</div>`;
    }
}

// Check authentication
if (!token) {
    window.location.href = '/login';
} else {
    loadPayment();
}
</script>
{% endblock %}

